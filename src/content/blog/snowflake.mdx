---
title: How to send Change Data Capture from Snowflake to Kafka
codetour: true
category: Learning
date: '2024-08-12'
description: 
image: /blog/building-secure-saas-platforms/build-secure-saas.png
author: Glenn Gillen
authorAvatar: /blog/glenn-gillen.jpg
---

{/* <!-- vale off--> */}

## Ockam setup

<CH.Scrollycoding style={{marginTop: '5rem', marginBottom: '5rem'}}>

```bash
curl --proto '=https' --tlsv1.2 -sSfL \
    https://install.command.ockam.io | \
    bash && source "$HOME/.ockam/env"

ockam enroll

ockam project ticket \
    --usage-count 1 --expires-in 10h \
    --attribute snowflake-kafka-inlet \
    > inlet.ticket
ockam project ticket \
    --usage-count 1 --expires-in 10h \
    --attribute snowflake-kafka-outlet \
    --relay kafka \
    > outlet.ticket

```

---

```bash focus=1:3
```

---

```bash focus=5
```

---

```bash focus=7
```

---

```bash focus=8
```

---

```bash focus=9
```

---

```bash focus=10
```

---

```bash focus=11:15
```

---

```bash focus=12,14
```

---

```bash focus=13
```
</CH.Scrollycoding>

### Get egress
```bash
ockam project show --jq .egress_allow_list
```

## Start Ockam MSK node via AWS marketplace

## Setup Snowflake

<CH.Scrollycoding style={{marginTop: '5rem', marginBottom: '5rem'}}>
```sql
USE ROLE ACCOUNTADMIN;

-- CREATE ROLES
CREATE OR REPLACE ROLE CDC_TEST_ROLE;

-- CREATE DATABASE
CREATE DATABASE IF NOT EXISTS CDC_TEST_DB;

-- CREATE WAREHOUSE
CREATE OR REPLACE WAREHOUSE CDC_TEST_WH WITH WAREHOUSE_SIZE='X-SMALL';

-- CREATE SCHEMA
CREATE SCHEMA IF NOT EXISTS CDC_TEST_SCHEMA;

-- CREATE COMPUTE POOL
CREATE COMPUTE POOL CDC_TEST_CP
  MIN_NODES = 1
  MAX_NODES = 5
  INSTANCE_FAMILY = CPU_X64_XS;

-- WAIT
DESCRIBE COMPUTE POOL CDC_TEST_CP;

-- CREATE IMAGE REPOSITORY
CREATE IMAGE REPOSITORY IF NOT EXISTS CDC_TEST_REPO;

--Note repository_url value to be used to build and publish consumer image to snowflake
SHOW IMAGE REPOSITORIES;

-- GRANTS
GRANT ROLE CDC_TEST_ROLE TO ROLE ACCOUNTADMIN;
GRANT ALL ON DATABASE CDC_TEST_DB TO ROLE CDC_TEST_ROLE;
GRANT ALL ON WAREHOUSE CDC_TEST_WH TO ROLE CDC_TEST_ROLE;
GRANT ALL ON SCHEMA CDC_TEST_SCHEMA TO ROLE CDC_TEST_ROLE;
GRANT ALL ON COMPUTE POOL CDC_TEST_CP TO ROLE CDC_TEST_ROLE;
GRANT READ ON IMAGE REPOSITORY CDC_TEST_REPO TO ROLE CDC_TEST_ROLE;
GRANT CREATE INTEGRATION ON ACCOUNT TO ROLE CDC_TEST_ROLE;

USE ROLE CDC_TEST_ROLE;
USE DATABASE CDC_TEST_DB;
USE WAREHOUSE CDC_TEST_WH;
USE SCHEMA CDC_TEST_SCHEMA;

-- CREATE TABLE
CREATE OR REPLACE TABLE CDC_TEST_TABLE (
    KEY VARCHAR(256),
    VALUE VARCHAR(256)
);
GRANT ALL ON TABLE CDC_TEST_TABLE TO ROLE CDC_TEST_ROLE;

-- CREATE STREAM
CREATE OR REPLACE STREAM CDC_TEST_TABLE_STREAM ON TABLE CDC_TEST_TABLE;
GRANT ALL ON STREAM CDC_TEST_TABLE_STREAM TO ROLE CDC_TEST_ROLE;
```

---

```sql focus=1
```

---

```sql focus=3:4
```

---

```sql focus=6:7
```

---

```sql focus=9:10
```

---

```sql focus=12:13
```

---

```sql focus=15:19
```

---

```sql focus=21:22
```

---


```sql focus=24:25
```

---


```sql focus=27:28
```

---


```sql focus=30:37
```

---


```sql focus=39
```

---

```sql focus=40
```

---

```sql focus=41
```

---

```sql focus=42
```

---

```sql focus=44:48
```

---


```sql focus=49
```

---

```sql focus=51:53
```

---
</CH.Scrollycoding>

## Build & push Python app image

<CH.Scrollycoding style={{marginTop: '5rem', marginBottom: '5rem'}}>
```bash
cd snowflake_cdc_publisher

docker login hycwvdm-ekb57526.registry.snowflakecomputing.com/cdc_test_db/cdc_test_schema/cdc_test_repo
docker build --rm --platform linux/amd64 -t \
    hycwvdm-ekb57526.registry.snowflakecomputing.com/cdc_test_db/cdc_test_schema/cdc_test_repo/snowflake_cdc_kafka_bridge \
    .
docker push hycwvdm-ekb57526.registry.snowflakecomputing.com/cdc_test_db/cdc_test_schema/cdc_test_repo/snowflake_cdc_kafka_bridge

docker login <repository_url>
docker build --rm --platform linux/amd64 -t \
    <repository_url>/snowflake_cdc_kafka_bridge .
docker push <repository_url>/snowflake_cdc_kafka_bridge
```

---

```bash focus=1
```

---

```bash focus=3
```

---

```bash focus=4:6
```

---

```bash focus=7
```

---

```bash focus=9
```

---

```bash focus=10:11
```

---

```bash focus=12
```
</CH.Scrollycoding>


## Deploy to Snowpark

<CH.Scrollycoding style={{marginTop: '5rem', marginBottom: '5rem'}}>

```sql
USE ROLE CDC_TEST_ROLE;
USE DATABASE CDC_TEST_DB;
USE WAREHOUSE CDC_TEST_WH;
USE SCHEMA CDC_TEST_SCHEMA;

CREATE OR REPLACE NETWORK RULE CDC_TEST_OSCP_OUT
TYPE = 'HOST_PORT' MODE= 'EGRESS'
VALUE_LIST = ('ocsp.snowflakecomputing.com:80');

CREATE NETWORK RULE CDC_TEST_OCKAM_OUT TYPE = 'HOST_PORT' MODE = 'EGRESS'
VALUE_LIST = ('TODO:TODO', 'TODO:TODO');

-- Create access integration
USE ROLE ACCOUNTADMIN;

CREATE OR REPLACE EXTERNAL ACCESS INTEGRATION CDC_TEST_EXTERNAL_ACCESS_INT
ALLOWED_NETWORK_RULES = (CDC_TEST_OSCP_OUT, CDC_TEST_OCKAM_OUT)
ENABLED = true;

GRANT USAGE ON INTEGRATION CDC_TEST_EXTERNAL_ACCESS_INT TO ROLE CDC_TEST_ROLE;

-- Create service
USE ROLE CDC_TEST_ROLE;

DROP SERVICE IF EXISTS SNOWFLAKE_CDC_KAFKA_BRIDGE;

CREATE SERVICE SNOWFLAKE_CDC_KAFKA_BRIDGE
  IN COMPUTE POOL CDC_TEST_CP
  FROM SPECIFICATION
$$
    spec:
      containers:
      - name: publisher
        image: /cdc_test_db/cdc_test_schema/cdc_test_repo/snowflake_cdc_kafka_bridge
        env:
          STREAM_NAME: CDC_TEST_DB.CDC_TEST_SCHEMA.CDC_TEST_TABLE_STREAM
          KAFKA_BOOTSTRAP_SERVERS: 127.0.0.1:9092
          KAFKA_TOPIC_NAME: test-topic
          SNOWFLAKE_WAREHOUSE: CDC_TEST_WH
          JOB_SUCCESS_SLEEP_TIME: 30
          JOB_ERROR_SLEEP_TIME: 60
          OCKAM_DISABLE_UPGRADE_CHECK: true
          OCKAM_OPENTELEMETRY_EXPORT: false
          ENROLLMENT_TICKET: "<OCKAM_ENROLLMENT_TICKET>"
$$
EXTERNAL_ACCESS_INTEGRATIONS = (CDC_TEST_EXTERNAL_ACCESS_INT)
MIN_INSTANCES=1
MAX_INSTANCES=1;

SHOW SERVICES;
SELECT SYSTEM$GET_SERVICE_STATUS('SNOWFLAKE_CDC_KAFKA_BRIDGE');
DESCRIBE SERVICE SNOWFLAKE_CDC_KAFKA_BRIDGE;
CALL SYSTEM$GET_SERVICE_LOGS('SNOWFLAKE_CDC_KAFKA_BRIDGE', '0', 'publisher', 1000);
```

---

```sql focus=1:4
```

---

```sql focus=6:8
```

---

```sql focus=10:11
```

---

```sql focus=13:20
```

---

```sql focus=22:29
```

---

```sql focus=30:45
```

---

```sql focus=34
```

---

```sql focus=36
```

---

```sql focus=37
```

---

```sql focus=38
```

---

```sql focus=39
```

---

```sql focus=44
```

---

```sql focus=46:48
```

---

```sql focus=50:53
```
</CH.Scrollycoding>

## Verify

```sql
-- Insert records
INSERT INTO CDC_TEST_TABLE
SELECT UUID_STRING(), randstr(255, RANDOM())
FROM TABLE(GENERATOR(ROWCOUNT => 100));

-- Verify Test Table and CDC Table
SELECT * FROM CDC_TEST_TABLE;
SELECT * FROM CDC_TEST_TABLE_STREAM;

-- Publisher checks for changes every 30 seconds. Looks at logs
CALL SYSTEM$GET_SERVICE_LOGS('SNOWFLAKE_CDC_KAFKA_BRIDGE', '0', 'publisher', 100);

-- Check for messages delivered to Kafka

-- Insert, Update and Delete
INSERT INTO CDC_TEST_TABLE (key, value) VALUES 
('key1', 'value1');

UPDATE CDC_TEST_TABLE SET value = 'updated_value1' WHERE key = 'key1';

-- Check for messages delivered to Kafka

-- Clear existing data
TRUNCATE TABLE CDC_TEST_TABLE;

-- Check for messages delivered to Kafka
```