---
title: Reverse ETL with Snowflake and Kafka
codetour: true
category: Learning
date: '2024-08-12'
description: 
image: /blog/building-secure-saas-platforms/build-secure-saas.png
author: Glenn Gillen
authorAvatar: /blog/glenn-gillen.jpg
---

{/* <!-- vale off--> */}

So you've got most of your organization's data consolidated into The Data Cloud
that we call Snowflake. Colleagues are busy analyzing the data and generating 
new insights. What if I told you there was a way to stream 
those insights in real-time back to the systems that can act upon them, and it 
will take you less than 15 minutes to setup?

Welcome to the world of Reverse ETL!

## What is "Reverse ETL"?

Snowflake has rapidly become _the_ place to support workloads such as data
warehouses, data lakes, data science / ML / AI, and even cybersecurity. This
centralization brings a huge amount of convenience in terms of breaking down
data silos and allowing teams to make smart data-informed decisions. The way
data typically gets into The Data Cloud is by one of:

* Writing directly to it!
* Syncing logs, metrics, and other data via a connector
* An Extract, Transform, and Load (ETL) process that runs regularly to move data from 
one system and load it into Snowflake

Reverse ETL is, as the name implies, simply running that process in the opposite
direction. Once the magic has been done in Snowflake one or more of your other
systems probably needs to act on the updated insights. Maybe the website needs to
know some additional data about a user? Maybe a CRM or email list needs to be 
updated? Whatever the reason, you need a way to get that data back out to the 
edges as quickly as possible. 

In this post I'm going to show you how to:

* Setup a Snowflake Stream to capture changes to a table in Snowflake
* Setup a managed Kafka cluster in AWS
* Connect Snowflake to Kafka with a private encrypted connection - without needing
to expose either system to the public internet!

## Snowflake streams 

Snowflake streams are a way to capture every change made to a table (i.e., every
insert, update, and delete) and record it somewhere else. It'll often be referred
to as Change Data Capture (CDC) and it's an effective way to respond to changes 
in the data that you care about. 

### Setting up stream...

TBD

## Amazon Managed Streaming for Kafka (MSK)

When implementing a reverse ETL process, the choice of tools can significantly impact the reliability, scalability, and efficiency of the solution. This is where Apache Kafka comes into play. Kafka is an open-source stream-processing platform that excels in handling real-time data feeds with high throughput and low latency.

### Setting up MSK

## Connecting Snowflake to Kafka

<ImageTour>
### !!steps Select a warehouse

Dolore amet irure tempor incididunt officia. Laborum duis in proident ex. Fugiat aliqua eu labore excepteur labore quis. In magna eiusmod sunt consequat ullamco do aliquip. Sit ullamco in eu mollit est aute enim nostrud Lorem deserunt minim reprehenderit. Exercitation anim ea ullamco voluptate nisi officia eiusmod. Officia cillum consectetur mollit adipisicing minim et ut ut.

![!tour Select a warehouse](/blog/snowflake-reverse-etl/select-warehouse.png)

### !!steps Grant account privileges

Minim aliquip enim amet exercitation qui ipsum officia et mollit labore aute velit. Cupidatat veniam occaecat ex elit occaecat. Nostrud dolore ea minim voluptate. Velit nostrud sint laborum magna esse irure nulla nostrud excepteur culpa. Aliqua labore laboris laborum duis qui elit est veniam velit duis velit.

![!tour Grant account privileges](/blog/snowflake-reverse-etl/grant-account.png)

### !!steps Activate app

Mollit aliquip proident esse reprehenderit adipisicing ea consectetur et ea. Velit adipisicing id aliqua aliquip sit sint sit. Officia enim minim veniam non ea reprehenderit enim nostrud duis aliqua tempor ullamco nisi. Ex exercitation esse minim aliquip commodo non mollit excepteur in dolor et esse.

![!tour Activate app](/blog/snowflake-reverse-etl/activate-app.png)

### !!steps Launch app

Magna aute dolore tempor elit. Cillum non quis ullamco ullamco est minim in. Fugiat veniam excepteur enim Lorem pariatur id occaecat mollit sunt cupidatat. Exercitation et consequat est consectetur est veniam mollit dolore id quis Lorem excepteur.

![!tour Launch app](/blog/snowflake-reverse-etl/launch-app.png)

### !!steps Get started

Consequat ea incididunt ullamco sit. Deserunt sit occaecat consectetur enim minim anim. Velit nulla ea occaecat duis qui dolor anim veniam sunt quis quis non. Occaecat labore mollit adipisicing mollit commodo nostrud Lorem esse commodo non incididunt id. Laboris deserunt cupidatat occaecat Lorem in quis labore qui mollit.

![!tour Get started](/blog/snowflake-reverse-etl/get-started.png)

### !!!steps Setup admin account

Consectetur aute esse magna aliqua et Lorem aliqua. Veniam sint et ad nisi exercitation minim consequat. Quis excepteur minim eu nulla reprehenderit occaecat qui proident proident irure nostrud exercitation magna cupidatat. Laboris sunt cupidatat Lorem ex.

![!tour Setup admin account](/blog/snowflake-reverse-etl/get-started-enroll.png)

### !!!steps Generate enrollment ticket for Kafka

Aute officia magna Lorem sit dolore consequat eiusmod enim velit. Nostrud et ea sint Lorem nulla in. Quis officia aliquip aliqua culpa ex deserunt sit in dolor mollit tempor. Dolor non mollit commodo amet id est. Quis reprehenderit reprehenderit adipisicing aute esse sint eu eiusmod aute enim.

![!tour Create outlets](/blog/snowflake-reverse-etl/create-outlets.png)

### !!!steps Launch Ockam node for Amazon MSK

Enim pariatur et anim anim minim amet excepteur enim dolore ipsum id quis aliquip. Excepteur labore esse non commodo qui aute tempor. Nostrud est amet non duis id ea mollit tempor eiusmod et sit magna.

### !!!steps Enter stack details

Dolore et aliquip pariatur aute ipsum tempor incididunt amet. Sint pariatur aliqua sit voluptate. Veniam amet Lorem dolor reprehenderit eu est enim dolore voluptate voluptate occaecat occaecat. Excepteur adipisicing commodo labore laborum in. Ut non eu culpa ea laborum non est velit pariatur excepteur aliqua deserunt pariatur. Fugiat esse veniam reprehenderit tempor.

### !!!steps Generate enrollment ticket for Snowflake

Id nostrud aliqua enim officia anim dolore laboris labore magna nulla magna. Sunt proident sunt sint aute exercitation culpa do dolore nisi nulla dolore commodo. Officia reprehenderit proident ex non aliqua reprehenderit proident et quis ea labore ipsum. Dolor irure est qui ipsum commodo. Elit occaecat deserunt fugiat fugiat id ipsum cupidatat consequat laboris veniam ex incididunt anim ut.

### !!!steps Configure connection details

Incididunt pariatur veniam duis est sunt qui consequat officia irure mollit sint. Consequat sunt occaecat culpa laborum. Magna dolor eu aliquip magna nisi sunt qui anim quis ad ullamco consectetur ad. Pariatur ex non cillum duis proident reprehenderit amet non eu. Qui eiusmod anim culpa reprehenderit nisi proident sunt in ex adipisicing. Aute laboris voluptate dolor aute officia minim aute ad anim non ut Lorem ea et.

### !!!steps Map Snowflake stream to Kafka topic

Occaecat ullamco aliqua culpa eiusmod velit amet. Fugiat cupidatat aute eu sit dolore magna fugiat ullamco commodo culpa fugiat. Laborum occaecat sit qui id dolore. Irure nulla nisi non mollit proident irure aliqua eu aliquip voluptate sint commodo.

### !!!steps Grant privileges

Nulla sit est officia ad tempor laboris voluptate. Est eu et mollit quis sit ad quis exercitation enim eiusmod magna velit ullamco adipisicing. Qui pariatur elit qui ex fugiat enim pariatur sint magna ea et. Ullamco esse dolore reprehenderit aute duis minim ex amet cupidatat sint. Velit aliquip quis nostrud id laboris consectetur proident. Exercitation culpa sint incididunt adipisicing qui.

### !!!steps Manually grant additional privileges

Reprehenderit aute ullamco elit sit irure pariatur mollit. Aute amet id pariatur non fugiat ullamco nisi ullamco irure. Proident dolore ut Lorem do occaecat ut sit non labore qui consectetur ipsum. Nostrud dolor esse voluptate laborum sint duis nostrud occaecat quis nostrud qui sint qui ullamco. Magna velit fugiat ut nostrud duis incididunt deserunt ex ullamco sint esse ullamco incididunt. Lorem sunt incididunt tempor amet occaecat duis cillum anim. Nisi incididunt eiusmod laborum nisi sit anim incididunt consequat commodo Lorem amet eiusmod sit.

</ImageTour>


```sql
CREATE OR REPLACE PROCEDURE grant_stream_permissions(STREAM_NAME STRING)
RETURNS STRING
LANGUAGE JAVASCRIPT
AS
$$
    // Define the fixed application name
    var APP_NAME = 'OCKAM_PUSH_TO_KAFKA_CONNECTOR_APP';

    // Function to get metadata by describing the stream
    function getStreamMetadata(streamName) {
        var sqlText = `DESCRIBE STREAM IDENTIFIER('${streamName}')`;
        var result = snowflake.execute({sqlText: sqlText});
        if (result.next()) {
            return {
                databaseName: result.getColumnValue("database_name"),
                schemaName: result.getColumnValue("schema_name"),
                baseTables: result.getColumnValue("table_name")
            };
        } else {
            return null;
        }
    }

    var metadata = getStreamMetadata(STREAM_NAME);

    if (!metadata) {
        return `Stream ${STREAM_NAME} not found or no metadata available.`;
    }

    var DB_NAME = metadata.databaseName;
    var SCHEMA_NAME = metadata.schemaName;
    var BASE_TABLES = metadata.baseTables;

    // Construct the GRANT statements
    var grants = [
        `GRANT USAGE ON DATABASE ${DB_NAME} TO APPLICATION ${APP_NAME}`,
        `GRANT USAGE ON SCHEMA ${DB_NAME}.${SCHEMA_NAME} TO APPLICATION ${APP_NAME}`,
        `GRANT SELECT ON TABLE ${BASE_TABLES} TO APPLICATION ${APP_NAME}`,
        `GRANT SELECT ON STREAM ${STREAM_NAME} TO APPLICATION ${APP_NAME}`
    ];

    // Execute the GRANT statements
    for (var i = 0; i < grants.length; i++) {
        try {
            snowflake.execute({sqlText: grants[i]});
        } catch (err) {
            return "Error executing: " + grants[i] + ". Error: " + err.message;
        }
    }

    return "All grants executed successfully";
$$;
```

```sql
CALL grant_stream_permissions('OPTKC_TEST_DATABASE.TEST_SCHEMA.CUSTOMERS_STREAM');
```